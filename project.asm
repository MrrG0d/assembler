.286
.model tiny
.386
STACK 256

.data
    sin db  'Enter function: $'
    signs db 16 dup ('0') ; ?????? ??????
    value dw 16 dup ('$') ; ?????? ????????
    
.code
    org 100h
Start:
    mov ax, @data
    mov ds, ax

    ; ??????????? ??? ??????
    lea dx, sin
    mov ah, 9
    int 21h
    
    call parcing ; ????? ??????? ? ?????????
    call schedule ; ?????????? ???????
    
    jmp exit

; ?????????? ???????? ? ??????
saveNum macro 
    lea di, value

    push dx
    mov dx, 2
    mov ax, cx
    mul dx
    pop dx
    
    add di, ax
    mov [di], dx
    xor dx, dx
endm

parcing:
    mov dl, '>'
    mov ah, 02h
    int 21h
    
    mov bx, 10 ; ?????????? ???????? ?? 10
    xor cx, cx ; ???????? ? ??????? ????????/??????
    xor dx, dx ; ???????? ???????? ????????

; ??????????? ???? ? ????????? ???????
.cicle:
    ; ???? ???????
    mov ah, 01h
    int 21h 
    cmp al, 0dh ; ???? ??????? ??????
    je .quit ; ?????????? ?????????? ???????? ? ?????
    
    cmp al, '0' ; ???? ?????? ????
    jb .isSign ; ??? ????
    cmp al, '9' ; ???? ?????? ??????
    ja .isExpOrX ; ??? ???? ?????????? ? ??????? ???? "?"

; ???? ??????? ?????, ?? ???? ?????
.isValue:
    xor ah, ah
    sub al, 30h ; ??????? ?? ??????? ? ?????
    push ax
    mov ax, dx
    mul bx ; ????????? ??????? ???????? ?? 10
    
    mov dx, ax
    pop ax
    add dx, ax ; ?????????? ? ???????? ???????? ???????? ?????
    jmp .cicle
    
; ????? ????
.isSign:
    lea di, signs
    add di, cx ; ???????? ? ???????
    mov [di+1], al ; ?????????? ?????
    jmp .saveValue ; ????????? ??????????? ?? ????? ????????

; ????? ?????????? ? ??????? ??? "?"
.isExpOrX:
    cmp al, 'x'
    jne .isSign ; ???? ?????????? ? ???????, ?? ??????? ? ???? ?? ??????
    mov dx, 'x' ; ????????? ? ??????? ????? "?"
    jmp .cicle

; ??????????? ???????? ? ??????
.saveValue:
    call checkSign ; ??????? ???????? ?????
    saveNum
    inc cx ; ?????????? ????????
    jmp .cicle

; ?????????? ?????????? ???????? ? ?????
.quit:
    lea di, signs
    add di, cx
    call checkSign
    saveNum
    ret

; ??????? ???????? ????? ??? ???????????? ????????
checkSign:
    cmp [di], byte ptr '-'
    jne .noMinus
    
    ; ???? ?????, ?? ?????? ???? ????????
    cmp dx, word ptr 'x'
    je .minusX
    neg dx
    jmp .zeroing
    
.minusX:
    mov dx, '-x'

; ???? "+" ??? "-", ?? ???????? ??????? ? ??????? ??????
.zeroing:
    mov [di], byte ptr '0'
    ret
    
.noMinus:
    cmp [di], byte ptr '+'
    je .zeroing
    ret

; ??????? ?????????? ????
axes:
.OX:
    mov ax, 99 ; ?????????? ???????? ???? ?? ?????? (?? ??????)
    mov bx, 320 ; ??? ? 1 ??????
    mul bx
    mov di,ax

    mov al, 7 ; ????
    mov cx, 320 ; ?????????? ???????? ? ?????
    rep stosb ; ??????????

    push 159 ; ???????? ? ?????? (?? ??????)
    mov bx, 0 ; ??????? ?????

.OY:
    pop ax
    mov di,ax
    add ax, 320 ; ??????? ?? ????????? ??????
    push ax ; ?????????? ????????
    
    mov al, 7
    mov cx, 1
    rep stosb ; ????? ???????
    inc bx
    cmp bx, 199 ; ???? ?????, ?? ?????
    jle .OY 

    ret    
   
; ??????? ?????? ??????? ?? ??????????? "?" ? "?"
paintPixel:
    mov di, 31839 ; 31839 = 320*99+159 ????? ??????? (0; 0) 
    push bp
    mov bp, sp
    mov ax, word ptr [bp+4] ; ???????? "?"
    
    cmp ax, 99
    jg .quit2 ; ???? ??????? ?? ??????? - ?????
    cmp ax, -99
    jl .quit2

    mov dx, 320
    mul dx
    neg ax

    add ax, word ptr [bp+6] ; ???????? "?"
    add di,ax     

    mov al, 7
    mov cx, 1
    rep stosb
    
.quit2:
    mov sp, bp
    pop bp
    ret

; ??????? ?????????? ???????
schedule:
    x dw 20 ; ???????????? ???????? "?"
    
    ; ??????????? ?????
    mov ah,00h
    mov al,13h
    int 10h
 
    mov ax,0A000h    
    mov es,ax  
    
.building:
    call value_y ; ??????? ?????????? "?"
    jo .again2 ; ???? ???? ????????????, ?? ?? ??????? ???????
    push x 
    push dx
    call paintPixel ; ??????? ?????? ???????
    add sp, 4

.again2:    
    dec x
    cmp x, -21
    jne .building
    
    call axes ; ??????? ?????????? ????
    ret

; ??????? ???????? ???????? ?? ?????????? ? ??????????? ????????
isX:
    ; ????? "?" ??? "+" ??? "-"
    cmp [si], word ptr 'x'
    je .positiveX
    cmp [si], word ptr '-x'
    je .negativeX
    
    mov bx, [si] ; ????????? ???????? ?? ???????
    jmp .exit2
    
.positiveX:
    mov bx, x
    jmp .exit2

.negativeX:
    mov bx, x
    neg bx
    
.exit2:  
    ret

; ??????? ???????? ???????? ?? ?????????? ? ??????????? ????????
; ?????? ??? ????? ?????
isPowX:
    cmp [si], word ptr 'x'
    je .assignValue
    cmp [si], word ptr '-x'
    je .assignValue
    
    mov bx, [si]
    cmp bx, 0
    jge .exit3
    
    neg bx
    jmp .exit3
   
.assignValue:
    mov bx, x
    
.exit3:  
    ret

; ??????? ?????????? "?" ??? ???????? "?"
value_y:
    xor dx, dx ; ?????
    lea si, value
    lea di, signs

    cmp [di+1], byte ptr '0' ; ???? ?????? ???? ??? ?? ????/?????
    jne .recursion ; ??????? ? ????????
    
    call isX ; ?????????? ???????? ?? ??????? ? bx
    mov dx, bx
    add si, 2 ; ??? ??????? ???????? ? 2 ?????
    inc di ; ??? ??????? ?????? ? 1 ????
    
; ?????????? ???????? ???????
.cicle2:
    cmp [si], word ptr '$' ; ???? ??????????? ????????
    je .quit3 ; ?? ?????
    
    cmp [di+1], byte ptr '0' ; ???? ????????? ?????? ?? ????/?????
    jne .recursion ; ??????? ? ????????
    
    ; ???? ????/?????, ??????? ?????? ?????????? ????? ? ????????
    call isX
    add dx, bx
    jo .quit3 ; ???? ???????????? - ?????
    inc di
    add si, 2
    jmp .cicle2

.quit3:
    ret
    
; ???????? ??? ?????????? ????? ???????, ??? ?????? ?????????/???????/???????
.recursion:
    push dx ; ????????? ??????? ?????
    mov cx, 1 ; ???????? ? ???????? (????? ??????? - ?????? ????? ????? ???????)
    
    cmp [di+1], byte ptr '^' ; ???? ????????? ???? ?????????? ? ???????
    je .power
    
    ; ????????? ?????? ????????
    call isX
    mov ax, bx
    jmp .again ; ???? ????????? ??????? ?????????? ? ???????? ?? ???????????

; ????????? ???? ??? ?????????? ? ???????
.isPower:
    cmp [di+1], byte ptr '^'
    je .power
    call isX

; ????????? ???? ?????????/???????
.isDivMul:
    cmp [di], byte ptr '/'
    je .division
    
    cmp [di], byte ptr '*'
    je .multiplication

    jmp .again

;?????????? ? ???????    
.power:
    call isPowX ; ????????, ?????????? ? ???????
    push bx
    add si, 2
    call isX ; ???????
    mov cx, bx
    dec cx
    pop bx
    mov ax, bx
    
    ; ???? ?????????? ? ???????
    .calc: imul ax, bx
        loop .calc
    
    mov cx, 2 ; ??????? ?? ???? ????? ???????
    sub si, 2 ; ? again ????????? 4 ? ????????? ????? ?? ???????? ????? ????????? ????
    
    cmp [si], word ptr '-x' ; ???? ??? ???? ?????????? ?? ?????? ?????
    je .changeSign ; ?????? ????
    cmp [si], word ptr 0 ; ???? ???????? ???? ?????? ????
    jge .exitPow ; ?????
    
.changeSign:
    neg ax 
    
.exitPow:
    mov bx, ax
    jmp .isDivMul
    
; ??????? ??????? ????? ?? ????????
.division:
    mov ax, dx
    cwd
    idiv bx
    
    jmp .again

; ????????? ??????? ????? ?? ????????
.multiplication:
    mov ax, dx
    imul ax, bx

; ???? ????????? ?????????? ? ???????? ?? ??????
.again:
    jo exit
    add di, cx ; ???????? ? ??????? ??????
    
    push ax
    mov ax, cx
    mov dx, word ptr 2
    mul dx
    pop dx
    
    add si, ax ; ???????? ? ??????? ????????
    mov cx, 1
    
    cmp [di], byte ptr '0' ; ???? ???????? ??? ????????
    jne .isPower ; ??????????
    
    pop ax ; ????? ?? ????????
    add dx, ax
    jmp .cicle2
    
exit:
    mov ax,4C00h
    int 21h
Code ENDS
    END Start